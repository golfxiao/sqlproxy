# sqlproxyç®€ä»‹

sqlproxyæ˜¯ä¸€ä¸ªåŸºäºkingshardäºŒæ¬¡å¼€å‘çš„ç”¨äºä¿¡åˆ›æ•°æ®åº“å¯¹æ¥çš„ä¸­é—´ä»¶é¡¹ç›®ï¼Œè‡´åŠ›äºç®€åŒ–å¼‚æ„æ•°æ®åº“çš„å¯¹æ¥å·¥ä½œï¼Œç›®æ ‡æ˜¯è®©ç°æœ‰åŸºäºMySQLçš„é¡¹ç›®æ— ç¼è¿ç§»åˆ°å…¶å®ƒç±»SQLå‹æ•°æ®åº“ï¼Œä¾‹å¦‚ï¼šOracleã€è¾¾æ¢¦ã€‚

sqlproxyçš„ä¸»è¦å·¥ä½œæ˜¯åœ¨ä¸­é—´ä»¶ä¸Šå¯¹ä¸åŒDBçš„è¯­æ³•å’Œåè®®ä½œè½¬æ¢ï¼Œä»¥ä¾¿ç°æœ‰ä¸šåŠ¡é¡¹ç›®ä¸æ”¹åŠ¨æˆ–å°½é‡å°‘æ”¹åŠ¨ï¼Œä½¿ç”¨åŸæ¥çš„MySQLè¯­æ³•å’Œé©±åŠ¨å°±èƒ½æ“ä½œå¦ä¸€ä¸ªä¿¡åˆ›æ•°æ®åº“ã€‚

## 1. ä½¿ç”¨è¯´æ˜

å°†etcç›®å½•ä¸‹çš„[etc/sqlproxy_example.yaml](./etc/sqlproxy_example.yaml)æ”¹åä¸ºsqlproxy.yamlï¼ŒåŸºäºæ­¤ç¤ºä¾‹æ–‡ä»¶æ¥ä¿®æ”¹è‡ªå·±çš„é…ç½®ï¼Œéœ€è¦é…çš„å†…å®¹ä¸‹é¢ä»‹ç»ã€‚

### 1.1 æ·»åŠ åç«¯æ•°æ®åº“é…ç½®
é…ç½®æ–‡ä»¶sqlproxy.yamlçš„`nodes`èŠ‚ç‚¹ç”¨æ¥é…ç½®åç«¯DBï¼Œæ”¯æŒé…ç½®å¤šä¸ªåç«¯DBï¼Œæ¯ä¸ªDBæ”¯æŒé…ç½®åç§°ã€é©±åŠ¨ã€è¿æ¥ä¸²ã€è¿æ¥æ•°ï¼Œå¦‚ä¸‹ï¼š
```
nodes:
  - # db alias name, used to specify db name for `use DB` command and the range of db that users can access.
    name: demodb
    # db driver name
    driver_name: dm

    # default max conns for connection pool
    max_conns_limit: 32

    # the db connection string. 
	# In the context of an Oracle database, the user needs to bind a user to a specific tablespace.
    datasource: dm://demouser:demopwd@192.168.23.216:5236
```

### 1.2 æ·»åŠ ç”¨æˆ·
é…ç½®æ–‡ä»¶sqlproxy.yamlä¸­çš„`user_list`èŠ‚ç‚¹ç”¨æ¥é…ç½®å…è®¸è¿æ¥åˆ°sqlproxyçš„ç”¨æˆ·åˆ—è¡¨ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦‚ä¸‹ï¼š
```
user_list:
  - user: testuser1
    password: testpwd1
  - user: testuser2
    password: testpwd2
```

### 1.3 é…ç½®ç”¨æˆ·èƒ½è®¿é—®çš„æ•°æ®åº“èŒƒå›´
é…ç½®æ–‡ä»¶sqlproxy.yamlä¸­çš„`schema_list`èŠ‚ç‚¹ç”¨æ¥é…ç½®æ¯ä¸ªç”¨æˆ·èƒ½è®¿é—®çš„åç«¯DBèŒƒå›´ï¼Œå¯ä»¥æ˜¯å¤šä¸ªï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·æ²¡æœ‰é…ç½®å¯è®¿é—®DBèŒƒå›´ï¼Œåˆ™é»˜è®¤ä¸ºæ‰€æœ‰DBå‡å¯è®¿é—®ã€‚å¦‚ä¸‹ï¼š

```
schema_list:
  - user: testuser1
    nodes: [ demodb ]
  - user: testuser2
    nodes: [ demodb ]
```

### 1.4 ç¼–è¯‘è¿è¡Œ
ç¼–è¯‘ï¼šè¿›å…¥sqlproxyé¡¹ç›®æ ¹ç›®å½•ï¼Œè¿è¡Œgo buildå¾—åˆ°ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
```
go build 
```
è¿è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡ï¼š
```
./sqlproxy -config ./etc/sqlproxy.yaml &
```

### 1.5 åº”ç”¨è¿æ¥ä¸­é—´ä»¶
å‡å¦‚ä¸€ä¸ªåº”ç”¨æœåŠ¡AåŸæ¥ä½¿ç”¨çš„æ˜¯MySQLæ•°æ®åº“ï¼Œç°åœ¨éœ€è¦å¯¹æ¥åŸºäºoracleè¯­æ³•çš„è¾¾æ¢¦æ•°æ®åº“ï¼Œç†è®ºä¸Šä»£ç å±‚ä¸ç”¨ä½œå¤§çš„æ”¹åŠ¨ï¼Œåªå°†DBè¿æ¥ä¸²ç”±åŸæ¥æŒ‡å‘MySQLæ”¹ä¸ºæŒ‡å‘æ­¤sqlproxyä¸­é—´ä»¶ï¼š
```
# åŸå§‹è¿æ¥ä¸²ï¼Œå‡å¦‚åŸå…ˆè¿æ¥çš„MySQLæœåŠ¡å™¨ä¸º192.168.23.215:3306
demouser:demopwd@tcp(192.168.23.215:3306)/pc3?timeout=1000ms&readTimeout=1000ms&writeTimeout=5000ms&charset=utf8

# å¯¹æ¥ä¿¡åˆ›åè¿æ¥ä¸²,å‡è®¾ä¿¡åˆ›ä¸­é—´ä»¶åœ°å€ä¸ºï¼š192.168.23.217:9696, testuser1ä¸ºä¸­é—´ä»¶ä¸Šä¸ºåº”ç”¨é…ç½®çš„ç”¨æˆ·å
testuser1:testpwd1@tcp(192.168.23.217:9696)/pc3?timeout=1000ms&readTimeout=1000ms&writeTimeout=5000ms&charset=utf8
```

ä¸­é—´ä»¶å·²ç»é’ˆå¯¹è¾¾æ¢¦æ•°æ®åº“åšäº†ä¸€éƒ¨åˆ†å·²çŸ¥çš„å¯¹æ¥å·¥ä½œï¼Œä¾‹å¦‚ï¼š
- replace intoè¯­å¥è½¬æ¢ä¸ºmerge intoï¼› 
- on duplidate key update è¯­å¥è½¬æ¢ä¸ºmerge intoè¯­å¥ï¼› 
- ä¸å…¼å®¹çš„åå¼•å·`æ›¿æ¢ä¸ºè¾¾æ¢¦ä¸­æ”¯æŒçš„åŒå¼•å·"ï¼› 
- ä¸å…¼å®¹çš„MySQLè½¬ä¹‰æ–¹å¼`\'`ï¼ˆæ–œæ è½¬ä¹‰ï¼‰æ›¿æ¢ä¸ºè¾¾æ¢¦ä¸­çš„è½¬ä¹‰æ–¹å¼`''`(å¼•å·è½¬ä¹‰)ï¼› 
- è¾¾æ¢¦é©±åŠ¨ä¸­çš„é•¿æ–‡æœ¬å­—æ®µç±»å‹DMClobè‡ªåŠ¨è½¬æ¢ä¸ºé€šç”¨çš„stringï¼›
- ä¸å…¼å®¹çš„MySQLæ—¶é—´æˆ³é›¶å€¼`0000-00-00 00:00:00`æ›¿æ¢ä¸ºè¾¾æ¢¦ä¸­çš„`0001-01-01 00:00:00`ï¼› 
- è¾¾æ¢¦é©±åŠ¨è¯»å‡ºçš„æ—¶é—´æˆ³æ ¼å¼ä¸º`2006-01-02T15:04:05.999999999Z07:00`,ä¸­é—´ä»¶ä¼šæ ¹æ®DBå­—æ®µå®šä¹‰è½¬æ¢ä¸ºåº”ç”¨éœ€è¦çš„æ ¼å¼ï¼› 
- å»æ‰è¾¾æ¢¦ä¸­ä¸æ”¯æŒçš„`force index`è¯­æ³•ï¼› 
- å»æ‰Insertè¯­å¥ä¸­è¾¾æ¢¦ä¸æ”¯æŒçš„è‡ªå¢åˆ—ï¼› 

é™¤è¿™äº›å¤–ï¼Œå¯èƒ½è¿˜ä¼šæœ‰å…¶å®ƒä¸å…¼å®¹çš„è¯­æ³•ï¼Œå¯ä»¥é€‰æ‹©åœ¨ä¸­é—´ä»¶ä¸ŠåšäºŒæ¬¡å¼€å‘ã€‚

## 2. äºŒæ¬¡å¼€å‘

æœ¬é¡¹ç›®ç›®å‰ä¸»è¦æ˜¯é’ˆå¯¹è¾¾æ¢¦æ•°æ®åº“ä½œäº†æ”¯æŒï¼Œæ”¯æŒå°†mysqlä¸­çš„`on duplicate key update`è¯­å¥è½¬æ¢æˆè¾¾æ¢¦ä¸­çš„`merge into`è¯­å¥ï¼Œä¸‹é¢å°±ä»¥æ­¤ä¸ºä¾‹ä»‹ç»å¦‚ä½•ä½œæ–°æ•°æ®åº“ä»¥åŠæ–°è¯­æ³•çš„æ‰©å±•ã€‚


### 2.1 æ‰©å±•è¯­æ³•æ ‘

å…³äºè¯­æ³•æ ‘çš„å®šä¹‰ï¼Œæœ‰å‡ ä¸ªæ¥å£æ˜¯æˆ‘ä»¬éœ€è¦éµå¾ªçš„ï¼š
- SQLNode: è¡¨ç¤ºè¯­æ³•æ ‘ä¸Šçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸è®ºæ˜¯ä¸€æ¡å®Œæ•´çš„è¯­å¥ï¼Œè¿˜æ˜¯ä¸€ä¸ªæ•°æ®å€¼æˆ–ä¸€ä¸ªåˆ—åç§°éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼› 
- Statement: è¡¨ç¤ºä¸€æ¡å®Œæ•´çš„SQLè¯­å¥ï¼Œä¾‹å¦‚`insert into person(id, name) values(1, 'zhangsan')`ï¼› 
- Expr: è¡¨ç¤ºä¸€æ¡è¯­æ³•ç‰‡æ®µï¼ŒåƒAndã€Orã€Existsç­‰éƒ½æ˜¯ä¸€ä¸ªè¯­æ³•ç‰‡æ®µï¼› 
```
// SQLNode defines the interface for all nodes
// generated by the parser.
type SQLNode interface {
	Format(buf *TrackedBuffer)
	// walkSubtree calls visit on all underlying nodes
	// of the subtree, but not the current one. Walking
	// must be interrupted if visit returns an error.
	walkSubtree(visit Visit) error
}

// Statement represents a statement.
type Statement interface {
	iStatement()
	SQLNode
}

// Expr represents an expression.
type Expr interface {
	iExpr()
	// replace replaces any subexpression that matches
	// from with to. The implementation can use the
	// replaceExprs convenience function.
	replace(from, to Expr) bool
	SQLNode
}
```
å…³äºè¯­æ³•æ ‘å®šä¹‰çš„æ›´è¯¦ç»†ä»£ç è§£è¯»ï¼Œå‚è€ƒï¼š[è¯­æ³•æ ‘ç»“æ„](./doc/Design/code_structure_sqlparser.md)

[sqlparser/ast.go](./sqlparser/ast.go)æ˜¯ä¸€æ£µMySQLè¯­æ³•æ ‘ï¼Œé‡Œé¢å·²ç»æ”¯æŒäº†MySQLä»¥åŠæ ‡å‡†SQLçš„ä¸»æµè¯­æ³•ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å·¥ä½œå°±æ˜¯æ‰©å±•è¿™æ£µè¯­æ³•æ ‘ï¼Œä»¥æ”¯æŒæ–°çš„è¯­æ³•ã€‚
merge intoæ˜¯ä¸€ä¸ªå¤šè¡¨æ•°æ®åˆå¹¶è¯­å¥ï¼ŒåŸºäºè”è¡¨æ¥å®ç°ï¼Œè¯­å¥ç¤ºä¾‹ï¼š
```
MERGE INTO demo_table t
USING dual
ON (t.column1 = 634311 AND t.column2 = 131722)
WHEN MATCHED THEN
    UPDATE SET t.column3 = '', t.column4 = 'this is demo column description'
WHEN NOT MATCHED THEN
    INSERT (column1, column2, column3, column4)
    VALUES (634311, 131722, '', 'this a demo column description');
```
è¿™æ¡è¯­å¥å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š
- Tableï¼š è”è¡¨è¯­å¥åŠæ¡ä»¶
- Matched: å½“æ¡ä»¶åŒ¹é…æ—¶è¦æ‰§è¡Œçš„æ“ä½œ
- Unmatched: å½“æ¡ä»¶ä¸åŒ¹é…æ—¶è¦æ‰§è¡Œçš„æ“ä½œ

```
type Merge struct {
	Comments  Comments
	Table     *MergeTableExpr
	Matched   MatchedExpr
	Unmatched *UnmatchedExpr
}

func (node *Merge) iStatement() {}

// Format formats the node.
func (node *Merge) Format(buf *TrackedBuffer) {
	buf.Myprintf("merge %vinto %v %v %v",
		â€¦â€¦
  )
}

func (node *Merge) walkSubtree(visit Visit) error {
	â€¦â€¦
}
```
ä¸Šé¢ç”¨åˆ°çš„MergeTableExprã€MatchedExprã€UnmatchedExpréƒ½éœ€è¦æŒ‰ç…§`merge into`è¯­æ³•æ¥ç»™å‡ºå…·ä½“çš„ç»“æ„å®šä¹‰ï¼Œæœ‰å…´è¶£å¯ä»¥æŸ¥çœ‹[sqlparser/ast_oracle.go](./sqlparser/ast_oracle.go)ï¼Œè¿™é‡Œä¸å†å±•å¼€æè¿°ã€‚

### 2.2 æ‰©å±•è¯­æ³•è½¬æ¢å™¨
ä¸ºç›®æ ‡è¯­æ³•å®šä¹‰å‡ºè¯­æ³•å¯¹è±¡ç»“æ„åï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªè½¬æ¢å™¨ï¼Œæ¥å°†åŸæ¥çš„MySQLè¯­æ³•è½¬æ¢æˆç›®æ ‡æ•°æ®åº“çš„è¯­æ³•ï¼Œè¯­æ³•è½¬æ¢å™¨éœ€è¦éµå¾ªä¸‹é¢çš„æ¥å£å®šä¹‰ï¼š
```
// å¯¹äºé¢„ç¼–è¯‘çš„SQLï¼Œå¦‚æœè½¬æ¢åçš„å ä½å‚æ•°ä¹Ÿæœ‰å˜åŒ–ï¼Œåˆ™è½¬æ¢å™¨éœ€è¦å°†å‚æ•°ä¹Ÿä¿®æ”¹å¹¶è¿”å›
type SQLConverter interface {
	Convert(sql string, args ...interface{}) (string, []interface{}, error)
}
```
é¡¹ç›®å·²ç»æ”¯æŒäº†`mysql-to-oracle`è¯­æ³•è½¬æ¢å™¨ï¼ˆè§[sqlparser/to_oracle.go](./sqlparser/to_oracle.go)ï¼‰ï¼Œä¹Ÿå¯ä»¥å®ç°å…¶å®ƒæ•°æ®åº“çš„è¯­æ³•è½¬æ¢å™¨ï¼Œæ–°çš„è¯­æ³•è½¬æ¢å™¨éœ€è¦åœ¨[sqlparser/convert.go](./sqlparser/convert.go)ä¸­æ„é€ å®ä¾‹å¯¹è±¡ï¼Œå¹¶é€šè¿‡`GetSQLConverter`æ–¹æ³•ç»Ÿä¸€å¯¹å¤–æä¾›è®¿é—®ï¼Œå¦‚ä¸‹ï¼š
```
func GetSQLConverter(name string, tableIndexs map[string]map[string][]string) SQLConverter {
	switch name {
	case MYSQL_TO_ORACLE:
		return NewOracleConverter(tableIndexs)
	default:
		return nil
	}
}
```

### 2.3 å¼•å…¥é©±åŠ¨
æˆ‘ä»¬ä½¿ç”¨Goå®˜æ–¹æ ‡å‡†çš„database/sqlæ¥å£æ¥è®¿é—®ç›®æ ‡æ•°æ®åº“ï¼Œç†è®ºä¸Šæ·»åŠ æ–°çš„SQLæ•°æ®åº“å¤©ç„¶å°±èƒ½æ”¯æŒï¼Œåªéœ€è¦å¼•å…¥å¯¹åº”çš„æ•°æ®åº“é©±åŠ¨ï¼Œå¦‚ä¸‹ï¼š
```
import _ "github.com/golfxiao/dm"
```

## 3. è®¾è®¡åŸç†

è¯·å‚è€ƒï¼š[sqlproxyè®¾è®¡è¿‡ç¨‹](./doc/Design/architecture.md)

## 4. åé¦ˆ
æ„Ÿè°¢æ‚¨é˜…è¯»è¿™ä¸ªæ•™ç¨‹ï¼Œå¦‚æœæ‚¨è§‰å¾—å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œå¯ä»¥è€ƒè™‘è¯·æˆ‘å–æ¯å’–å•¡ä½œä¸ºé¼“åŠ±ğŸ˜Š

![a cup of tea](./doc/Design/resources/cup_of_tea.jpg)

å¦‚æœæ‚¨åœ¨ä½¿ç”¨sqlproxyçš„è¿‡ç¨‹ä¸­å‘ç°BUGæˆ–è€…æœ‰æ–°çš„åŠŸèƒ½éœ€æ±‚ï¼Œè¯·å‘é‚®ä»¶è‡³golfxiao@163.comä¸ä½œè€…å–å¾—è”ç³»ï¼Œæˆ–è€…æ·»åŠ ä½œè€…å¾®ä¿¡ï¼š

<img src="./doc/Design/resources/weixin_pic.jpg" width="20%" height="20%"/>